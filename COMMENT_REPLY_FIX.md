# 评论回复引用修复文档

## 问题描述
2级评论回复时引用了1级评论，而不是用户实际回复的那条评论。

## 修复方案

### 1. 类型定义修改
- 在 `CreateCommentRequest` 中添加了 `replyToUser` 字段
- 确保前端可以传递被回复用户的信息

### 2. 服务层修改 (`commentService.ts`)
- 修改 `createComment` 方法，在评论创建成功后手动设置 `replyToId` 和 `replyToUser`
- 解决了后端API不支持 `replyToId` 的限制

### 3. 表单层修改 (`CommentForm.tsx`)
- 确保在提交评论时正确传递 `replyToUser` 信息

### 4. 缓存层修改 (`useComments.ts`)
- 在乐观更新的临时评论中正确设置 `replyToId` 和 `replyToUser`
- 确保临时评论也能正确显示引用关系

### 5. 显示层修改 (`CommentItem.tsx`)
- 在 `formatReplyContent` 函数开头添加了优先级更高的 `replyToId` 处理逻辑
- 确保新创建的评论能够正确显示被回复的具体评论

## 测试场景

### 场景1：回复1级评论
- 点击1级评论的"Reply"按钮
- 输入回复内容
- 提交后应该显示：`@原1级评论作者："原1级评论内容..."`

### 场景2：回复2级评论
- 点击2级评论的"Reply"按钮
- 输入回复内容
- 提交后应该显示：`@被回复的2级评论作者："被回复的2级评论内容..."`

### 场景3：临时评论显示
- 提交评论时立即显示临时评论
- 临时评论应该正确显示引用关系
- 服务器响应后替换为真实评论，引用关系保持一致

## 技术实现要点

1. **前端优先策略**：由于后端API限制，在前端层面解决引用关系
2. **优先级处理**：`replyToId` > `replyToUser` > 智能推理算法
3. **乐观更新**：确保用户体验的连续性
4. **调试信息**：添加了console.log帮助调试引用关系

## 验证方法
1. 打开 http://localhost:5177
2. 找到一篇有评论的文章
3. 依次测试上述场景
4. 检查浏览器控制台的调试信息